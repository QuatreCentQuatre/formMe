"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}var FormManager=function(){function t(e){_classCallCheck(this,t),this.name="FormManager",this.forms=[]}return _createClass(t,[{key:"initForms",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:$("html");this.clearForms();for(var t=e.find("[me\\:form]"),a=[],i=0;i<t.length;i++){var n=$(t[i]),r=n.attr("me:form"),s={el:n[0],name:r,params:{}};"function"==typeof Me.forms[r]?n.attr("me:form:render")||(n.attr("me:form:render","true"),n=n.attr("me:form:data"),s.params=n?JSON.parse(n):{},s=new Me.forms[r](s),this.forms.push(s),a.push(s)):console.warn("You need to have form that exist.",r)}for(var o=0;o<a.length;o++)a[o].initialize()}},{key:"clearForms",value:function(){var e,t=[];for(e in this.forms){var a=this.forms[e];"object"==_typeof(a.$el)&&(0<$("html").find(a.$el[0]).length?t.push(a):a.terminate())}this.forms=t}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}}]),t}();window.Me||(window.Me={}),Me.formManager=new FormManager,Me.forms=[],$(document).ready(function(){Me.formManager.initForms()});var FormBase=function(){function t(e){_classCallCheck(this,t),this.classes={valid:"is-valid",invalid:"is-invalid",error:"has-error",serverError:"has-server-error",serverSuccess:"has-server-success"},this.el=e.el,this.$el=$(e.el),this.params=Object.assign(this.defaults(),e.params),this.$submit=0<this.$el.find("[me\\:form\\:submit]").length?this.$el.find("[me\\:form\\:submit]"):this.$el.find('[type="submit"]'),this.name=e.name||"FormBasic",this.fields=[],this.ajax=!!this.$el.attr("ajax"),this.method=this.$el.attr("method"),this.action=this.$el.attr("action"),this.dataType="json",this.antiSpam=!1,this.initialized=!1,this.recaptcha="undefined"!=typeof grecaptcha&&this.ajax&&(!this.el.hasAttribute("recaptcha")||"false"!==this.$el.attr("recaptcha")),this.recaptcha&&(this.recaptchaAction=null!==(e=this.$el.attr("recaptcha-action"))&&void 0!==e?e:"",this.recaptchaInputName="g-recaptcha-response",this.$recaptchaInput=this.$el.find('input[name="'.concat(this.recaptchaInputName,'"]'))),this.options={debug:!(!window.SETTINGS||!SETTINGS.DEBUG_MODE)&&SETTINGS.DEBUG_MODE}}return _createClass(t,[{key:"defaults",value:function(){return{}}},{key:"initialize",value:function(){this.dependenciesExist()&&this.requirementsExit()&&(this.validation=new Me.validate(this),this.addFields(this.fields),this.fields=null,this.addEvents(),this.initialized=!0)}},{key:"addEvents",value:function(){var t=this;this.$submit&&this.$submit.on("click.formMe",function(e){t.submitHandler(e)}),this.$el.on("submit.formMe",function(e){t.submitHandler(e)})}},{key:"removeEvents",value:function(){this.$submit&&this.$submit.off("click.formMe"),this.$el.off("submit.formMe")}},{key:"addFields",value:function(e){var a=this;e.forEach(function(e,t){a.addField(e)})}},{key:"addField",value:function(t){this.validation.fields.findIndex(function(e){return e.name===t.name})<0?this.validation.addField(t):this.initialized&&console.warn("This field already exist",t)}},{key:"removeFields",value:function(e){var a=this;e.forEach(function(e,t){a.removeField(e)})}},{key:"removeField",value:function(e){this.validation.getField(e)?(this.resetFieldState(this.getField(e)),this.validation.removeField(e)):console.warn("This field does not seems to exist.","Field name: "+e)}},{key:"getField",value:function(t){return this.validation.fields.find(function(e){return e.name===t})}},{key:"submitHandler",value:function(e){this.antiSpam||(this.antiSpam=!0,this.ajax&&e&&e.preventDefault(),this.validation.validate()||e.preventDefault())}},{key:"onValidationSuccess",value:function(e){var a=this;e.forEach(function(e,t){a.resetFieldState(e)}),this.$el.removeClass(this.classes.invalid).addClass(this.classes.valid),this.ajax&&(this.recaptcha?grecaptcha.execute(SETTINGS.RECAPTCHA_KEY,{action:this.recaptchaAction}).then(function(e){a.$recaptchaInput.val(e),a.handleAjaxSend(a.formatFormData(a.$el.serializeArray()))}):this.handleAjaxSend(this.formatFormData(this.$el.serializeArray())))}},{key:"onValidationError",value:function(e,t){var a=this;e.forEach(function(e,t){a.resetFieldState(e)}),t.forEach(function(e,t){a.handleValidationErrorField(e)}),this.$el.addClass(this.classes.invalid),this.antiSpam=!1}},{key:"resetFieldState",value:function(e){e.error&&e.error.addClass("hide").attr("aria-hidden",!0),e.$el.removeClass(this.classes.error)}},{key:"handleValidationErrorField",value:function(e){e.error&&e.error.removeClass("hide").attr("aria-hidden",!1),e.$el.addClass(this.classes.error)}},{key:"handleAjaxSend",value:function(e){var t=this;$.ajax({method:this.method,url:this.action,data:e,dataType:this.dataType,processData:!1,cache:!1,contentType:!1,success:function(e){t.ajaxSuccess(e)},error:function(e){t.ajaxError(e)},complete:function(){t.ajaxComplete()}})}},{key:"ajaxSuccess",value:function(e){"json"===this.dataType&&0===Object.entries(e).length&&console.warn("No values returned by the service."),this.reset(),this.$el.removeClass(this.classes.serverError).addClass(this.classes.serverSuccess)}},{key:"ajaxError",value:function(e){this.$el.removeClass(this.classes.serverSuccess).addClass(this.classes.serverError)}},{key:"ajaxComplete",value:function(){this.antiSpam=!1}},{key:"formatFormData",value:function(e){var n=this,r=new FormData;return e.forEach(function(e,t){var a,i=$('[name="'.concat(e.name,'"]'));""===e.value||i.disabled||i.attr("file")||(a=n.getField(e.name),i=e.value,void 0!==a&&a.hasOwnProperty("format")&&(i=a.format(i)),r.append(e.name,i))}),this.validation.fields.forEach(function(e,t){if(null!=e.file_type){var a=$('[name="'.concat(e.name,'"]'));if(a[0].files[0])for(var i in e.name.includes("[]")||(e.name="".concat(e.name,"[]")),a[0].files)a[0].files[i].name&&a[0].files[i].size&&r.append(e.name,a[0].files[i])}}),r}},{key:"dependenciesExist",value:function(){var e=!0;return window.$||(e=!1,console.error("Form ".concat(this.name," needs Jquery."))),window.Me&&window.Me.validate||(e=!1,console.error("Form ".concat(this.name," needs ValidateMe (https://github.com/QuatreCentQuatre/validateMe/)"))),e}},{key:"requirementsExit",value:function(){var e=!0;if(0<!this.$el.length&&(e=!1,console.error("Couldn't find associated form name",this.name)),this.method||(e=!1,console.error("".concat(this.name," needs to have a method"))),this.action||(e=!1,console.error("".concat(this.name," needs to have an action attribute"))),this.fields&&!(this.fields&&this.fields.length<=0))return 0<!this.$submit.length&&(e=!1,console.error("".concat(this.name," needs to have a submit button"))),this.recaptcha&&(window.SETTINGS&&SETTINGS.RECAPTCHA_KEY||(e=!1,console.error("SETTINGS.RECAPTCHA_KEY needs to be defined")),this.recaptchaAction||(e=!1,console.error("".concat(this.name," needs to have a recaptcha-action attribute"))),0===this.$recaptchaInput.length&&(e=!1,console.error("".concat(this.name,' needs to have a input[name="').concat(this.recaptchaInputName,'"]')))),e;console.error("".concat(this.name," needs a list of fields. To see what you need to add go check de README.md"))}},{key:"reset",value:function(){return this.validation.reset(),this}},{key:"terminate",value:function(){this.removeEvents()}},{key:"name",get:function(){return this._name},set:function(e){"string"==typeof e?this._name=e:console.error("The name parameter must be a string")}},{key:"dataType",get:function(){return this._dataType},set:function(e){"string"==typeof e?this._dataType=e:console.error("The dataType parameter must be a string")}},{key:"ajax",get:function(){return this._ajax},set:function(e){"boolean"==typeof e?this._ajax=e:console.error("The bool parameter must be a boolean")}},{key:"method",get:function(){return this._method},set:function(e){"string"==typeof e?this._method=e:console.error("The method parameter must be a string")}},{key:"action",get:function(){return this._action},set:function(e){"string"==typeof e?this._action=e:console.error("The method parameter must be a string")}},{key:"antiSpam",get:function(){return this._antiSpam},set:function(e){"boolean"==typeof e?this._antiSpam=e:console.error("The bool parameter must be a boolean")}},{key:"fields",get:function(){return this._fields},set:function(e){"object"!==_typeof(e)&&0<e.length?console.error("The fields parameter must be an array"):this._fields=e}},{key:"initialized",get:function(){return this._initialized},set:function(e){this._initialized=e}},{key:"recaptcha",get:function(){return this._recaptcha},set:function(e){"boolean"==typeof e?this._recaptcha=e:console.error("The recaptcha parameter must be a boolean")}},{key:"recaptchaAction",get:function(){return this._recaptchaAction},set:function(e){"string"==typeof e?this._recaptchaAction=e:console.error("The recaptchaAction parameter must be a string")}},{key:"recaptchaInputName",get:function(){return this._recaptchaInputName},set:function(e){"string"==typeof e?this._recaptchaInputName=e:console.error("The recaptchaInputName parameter must be a string")}}]),t}();Me.forms.FormBase=FormBase;